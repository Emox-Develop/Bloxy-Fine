<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Bloxluck | Coin Flip Edition</title>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.min.js"></script>
<style>
:root{--bg:#0d0f13;--panel:#15181f;--card:#1c2028;--border:#262a33;--green:#2ecc71;--red:#e74c3c;--gray:#8a9199;--gold:#f1c40f;--blue:#3498db}
*{box-sizing:border-box; margin:0; padding:0;}
body{background:var(--bg);color:#fff;font-family:'Segoe UI',sans-serif;display:flex;height:100vh;overflow:hidden}
.sidebar{width:70px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding-top:20px}
.main{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
.chat-area{width:300px;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column}
.header{height:65px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 30px;justify-content:space-between}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:none;align-items:center;justify-content:center}
.box{background:var(--panel);padding:25px;border-radius:15px;width:500px;text-align:center;border:1px solid var(--border)}
.grid{display:grid;grid-template-columns:repeat(5, 1fr);gap:8px;margin:15px 0;max-height:300px;overflow-y:auto;padding:5px}
.inv-card{background:var(--card);padding:5px;border-radius:8px;cursor:pointer;border:2px solid transparent}
.inv-card img{width:100%}
.inv-card.selected{border-color:var(--green); background: rgba(46, 204, 113, 0.1);}

/* PARA ANÄ°MASYONU */
.coin-container{perspective:1000px;width:130px;height:130px;margin:30px auto;display:block}
.coin{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 3s cubic-bezier(0.1, 0, 0.1, 1)}
.coin div{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:70px;font-weight:900;border:6px solid rgba(255,255,255,0.4)}
.coin .heads{background:linear-gradient(45deg, #2980b9, var(--blue)); color:white; transform: rotateY(0deg); box-shadow: 0 0 30px var(--blue);}
.coin .tails{background:linear-gradient(45deg, #c0392b, var(--red)); color:white; transform: rotateY(180deg); box-shadow: 0 0 30px var(--red);}

/* MAÃ‡ KARTI VE KÃœÃ‡ÃœLTÃœLMÃœÅž RESÄ°MLER */
.match-card{background:var(--card);padding:12px 15px;margin-bottom:10px;border-radius:12px;display:flex;flex-direction:column;gap:8px;border:1px solid var(--border);animation:fadeIn 0.2s}
.match-top{display:flex; justify-content:space-between; align-items:center}
.side-icon{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px}
.side-h{background:var(--blue);box-shadow:0 0 10px var(--blue)}
.side-t{background:var(--red);box-shadow:0 0 10px var(--red)}
.item-display-area{display:flex; flex-wrap:wrap; gap:6px; background:rgba(0,0,0,0.15); padding:8px; border-radius:8px}
.item-mini-img{width:40px !important; height:40px !important; background:var(--panel); padding:4px; border-radius:6px; border:1px solid var(--border); object-fit: contain;}

#chat-msgs{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.msg{background:var(--card);padding:8px;border-radius:8px;border:1px solid var(--border);font-size:13px}
.msg b{color:var(--green);font-size:10px;display:block}
.btn{background:var(--green);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%;font-size:13px}
.side-btn{border:2px solid var(--border);background:var(--panel);color:white;padding:10px;width:48%;border-radius:8px;cursor:pointer}
.side-btn.active-h{border-color:var(--blue);background:rgba(52, 152, 219, 0.1)}
.side-btn.active-t{border-color:var(--red);background:rgba(231, 76, 60, 0.1)}
</style>
</head>
<body>

<div id="flip-modal" class="modal-overlay">
    <div class="box">
        <h2 id="flip-status">ZARLAR ATILIYOR...</h2>
        <div class="coin-container">
            <div id="coin-element" class="coin">
                <div class="heads">H</div>
                <div class="tails">T</div>
            </div>
        </div>
        <p id="winner-text" style="font-weight:bold; font-size:20px; margin-top:15px; height: 30px;"></p>
    </div>
</div>

<div id="login-modal" class="modal-overlay" style="display:none">
    <div class="box">
        <h2>Roblox GiriÅŸ</h2>
        <input type="text" id="rbx-name" placeholder="KullanÄ±cÄ± AdÄ±...">
        <button class="btn" onclick="nextStep()">Kodu Al</button>
        <div id="verify-section" style="display:none; margin-top:15px">
            <h3 id="v-code" style="color:var(--green); margin:10px 0"></h3>
            <button class="btn" onclick="finishLogin()">GiriÅŸ Yap</button>
        </div>
    </div>
</div>

<div id="inv-modal" class="modal-overlay">
    <div class="box">
        <h3 id="inv-title">EÅŸya SeÃ§</h3>
        <div id="side-select" style="display:flex; justify-content:space-between; margin:15px 0">
            <button class="side-btn active-h" id="btn-h" onclick="selectSide('H')">MAVÄ° (H)</button>
            <button class="side-btn" id="btn-t" onclick="selectSide('T')">KIRMIZI (T)</button>
        </div>
        <div class="grid" id="inventory-grid"></div>
        <button class="btn" onclick="handleConfirm()">ONAYLA</button>
        <button class="btn" onclick="closeInv()" style="margin-top:5px; background:var(--red)">KAPAT</button>
    </div>
</div>

<div class="sidebar"></div>
<div class="main">
    <div class="header">
        <div style="font-weight:900; font-size:18px">BLOX<span style="color:var(--green)">LUCK</span></div>
        <div class="user-info"><span id="u-name">...</span> | ðŸ’° <span id="u-inv">0</span></div>
    </div>
    <div style="padding:20px; overflow-y: auto; flex:1">
        <button class="btn" style="width:150px" onclick="openInvForCreate()">MAÃ‡ OLUÅžTUR</button>
        <div id="match-list" style="margin-top:20px"></div>
    </div>
</div>

<div class="chat-area">
    <div id="chat-msgs"></div>
    <div style="padding:15px"><input type="text" id="chat-input" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendMsg()"></div>
</div>

<script>
let user = localStorage.getItem('rbx_user') || "";
let invCount = localStorage.getItem('rbx_inv') ? parseInt(localStorage.getItem('rbx_inv')) : 50;

const pubnub = new PubNub({
    publishKey: "pub-c-134bcaab-4830-4bbb-afb4-b7595ffffebe",
    subscribeKey: "sub-c-5f27998e-cff7-4c72-9ad1-455b7adeb737",
    uuid: user || "u_" + Math.random().toString(16).slice(2, 8)
});

pubnub.subscribe({ channels: ["CHAT_V201_COMPACT", "MATCH_V201_COMPACT"] });

// HAYALET MAÃ‡LARI Ã–NLEYEN YENÄ° SÄ°STEM
function fetchHistory() {
    pubnub.history({ channel: "CHAT_V201_COMPACT", count: 15 }, (s, r) => {
        if(r) r.messages.forEach(m => receiveChat(m.entry.u, m.entry.t));
    });
    // MaÃ§ geÃ§miÅŸini Ã§ekmiyoruz Ã§Ã¼nkÃ¼ eski maÃ§lar kafa karÄ±ÅŸtÄ±rÄ±yor. 
    // Sadece o an aktif olanlar gelecek.
}

pubnub.addListener({
    message: (m) => {
        if(m.channel === "CHAT_V201_COMPACT" && m.message.u !== user) receiveChat(m.message.u, m.message.t);
        if(m.channel === "MATCH_V201_COMPACT") {
            if(m.message.type === 'new') addMatchToUI(m.message.user, m.message.id, m.message.amt, m.message.side);
            if(m.message.type === 'cancel' || m.message.type === 'roll') document.getElementById(m.message.id)?.remove();
            if(m.message.type === 'roll') startCoinFlip(m.message.id, m.message.res, m.message.creator, m.message.joiner, m.message.amt, m.message.cSide);
        }
    }
});

let selectedSide = 'H';
let selectedCount = 0;
let joinId = null;
let reqAmt = 0;

function selectSide(s) {
    selectedSide = s;
    document.getElementById('btn-h').className = s === 'H' ? 'side-btn active-h' : 'side-btn';
    document.getElementById('btn-t').className = s === 'T' ? 'side-btn active-t' : 'side-btn';
}

function handleConfirm() {
    if(selectedCount === 0) return;
    if(joinId) {
        if(selectedCount !== reqAmt) return alert("Hata: " + reqAmt + " eÅŸya seÃ§!");
        const result = Math.random() > 0.5 ? 'H' : 'T';
        const matchData = document.getElementById(joinId).dataset;
        pubnub.publish({ channel: "MATCH_V201_COMPACT", message: { 
            type: 'roll', id: joinId, res: result, creator: matchData.owner, joiner: user, amt: reqAmt, cSide: matchData.side 
        }});
        invCount -= selectedCount;
    } else {
        const mId = "M_" + Math.random().toString(36).substr(2, 8);
        pubnub.publish({ channel: "MATCH_V201_COMPACT", message: { type: 'new', user: user, id: mId, amt: selectedCount, side: selectedSide }});
        addMatchToUI(user, mId, selectedCount, selectedSide);
        invCount -= selectedCount;
    }
    updateUI(); closeInv();
}

function startCoinFlip(id, res, creator, joiner, amt, cSide) {
    const modal = document.getElementById('flip-modal');
    const coin = document.getElementById('coin-element');
    const winnerTxt = document.getElementById('winner-text');
    modal.style.display = "flex";
    winnerTxt.innerText = ""; 
    coin.style.transition = "none";
    coin.style.transform = "rotateY(0deg)"; 
    setTimeout(() => {
        coin.style.transition = "transform 3s cubic-bezier(0.1, 0, 0.1, 1)";
        coin.style.transform = res === 'H' ? "rotateY(2160deg)" : "rotateY(2340deg)";
        setTimeout(() => {
            const winner = (res === cSide) ? creator : joiner;
            winnerTxt.innerText = "KAZANAN: " + winner;
            winnerTxt.style.color = (winner === user) ? "var(--green)" : "var(--red)";
            if(winner === user) { invCount += (amt * 2); updateUI(); }
            setTimeout(() => { modal.style.display = "none"; }, 2000);
        }, 3100);
    }, 50);
}

function addMatchToUI(owner, id, amt, side) {
    if(document.getElementById(id)) return;
    const list = document.getElementById('match-list');
    const div = document.createElement('div');
    div.className = "match-card"; div.id = id;
    div.dataset.owner = owner; div.dataset.side = side;
    div.innerHTML = `
        <div class="match-top">
            <div class="match-user-info"><span class="side-icon ${side==='H'?'side-h':'side-t'}">${side}</span> <b>${owner}</b></div>
            <div class="value-tag">ðŸ’Ž ${(amt * 425).toLocaleString()}</div>
        </div>
        <div class="item-display-area">${'<img src="https://supremevalues.com/media/mm2ancients/Harvester.png" class="item-mini-img">'.repeat(amt)}</div>
        <div style="display:flex; justify-content:flex-end">
            ${owner === user ? `<button class="btn" style="background:var(--red); width:80px" onclick="cancelMatch('${id}', ${amt})">Ä°PTAL</button>` 
            : `<button class="btn" style="width:80px" onclick="openInvForJoin('${id}', ${amt})">KATIL</button>`}
        </div>
    `;
    list.prepend(div);
}

function updateUI() { document.getElementById('u-inv').innerText = invCount; localStorage.setItem('rbx_inv', invCount); document.getElementById('u-name').innerText = user; }
function openInvForCreate() { joinId = null; document.getElementById('side-select').style.display="flex"; openInv(); }
function openInvForJoin(id, amt) { joinId = id; reqAmt = amt; document.getElementById('side-select').style.display="none"; openInv(); }
function openInv() {
    const grid = document.getElementById('inventory-grid'); grid.innerHTML = ""; selectedCount = 0;
    for(let i=0; i < invCount; i++) {
        const item = document.createElement('div'); item.className = "inv-card";
        item.innerHTML = `<img src="https://supremevalues.com/media/mm2ancients/Harvester.png">`;
        item.onclick = () => { if(item.classList.toggle('selected')) selectedCount++; else selectedCount--; };
        grid.appendChild(item);
    }
    document.getElementById('inv-modal').style.display = "flex";
}
function cancelMatch(id, amt) { pubnub.publish({ channel: "MATCH_V201_COMPACT", message: { type: 'cancel', id: id } }); document.getElementById(id)?.remove(); invCount += amt; updateUI(); }
function sendMsg() { const i = document.getElementById('chat-input'); if(!i.value.trim()) return; pubnub.publish({ channel: "CHAT_V201_COMPACT", message: { u: user, t: i.value } }); receiveChat(user, i.value); i.value = ""; }
function receiveChat(u, t) { const box = document.getElementById('chat-msgs'); const div = document.createElement('div'); div.className = "msg"; div.innerHTML = `<b>${u}</b> ${t}`; box.appendChild(div); box.scrollTop = box.scrollHeight; }
function nextStep() { document.getElementById('v-code').innerText = "LUCK-" + Math.floor(1000 + Math.random()*9000); document.getElementById('verify-section').style.display = "block"; }
function finishLogin() { user = document.getElementById('rbx-name').value; localStorage.setItem('rbx_user', user); location.reload(); }
function closeInv() { document.getElementById('inv-modal').style.display = "none"; }
window.onload = () => { if(!user) document.getElementById('login-modal').style.display = "flex"; else { updateUI(); fetchHistory(); } };
</script>
</body>
</html>
