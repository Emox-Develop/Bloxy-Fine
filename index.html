<script>
let user = localStorage.getItem('rbx_user') || "";
let invCount = localStorage.getItem('rbx_inv') ? parseInt(localStorage.getItem('rbx_inv')) : 50;
// Sayfa yenilenince maÃ§larÄ±n gitmemesi iÃ§in hafÄ±zayÄ± gÃ¼Ã§lendirdik
let allMatches = JSON.parse(localStorage.getItem('global_matches_v3') || "[]");
let chatHistory = JSON.parse(localStorage.getItem('chat_history') || "[]");

const ITEM_IMG = "https://supremevalues.com/media/mm2ancients/Harvester.png";
const HARVESTER_VALUE = 425;
const CH_CHAT = "CHAT_V201_COMPACT";
const CH_MATCH = "MATCH_V201_COMPACT";

const pubnub = new PubNub({
    publishKey: "pub-c-134bcaab-4830-4bbb-afb4-b7595ffffebe",
    subscribeKey: "sub-c-5f27998e-cff7-4c72-9ad1-455b7adeb737",
    uuid: user || "u_" + Math.random().toString(16).slice(2, 8)
});

pubnub.subscribe({ channels: [CH_CHAT, CH_MATCH] });

pubnub.addListener({
    status: (s) => { if(s.category === "PNConnectedCategory") document.getElementById('chat-status').style.color = "var(--green)"; },
    message: (m) => {
        if(m.channel === CH_CHAT && m.message.u !== user) receiveChat(m.message.u, m.message.t, true);
        if(m.channel === CH_MATCH) {
            if(m.message.type === 'new') {
                saveAndRenderMatch(m.message.user, m.message.id, m.message.amt);
            }
            if(m.message.type === 'cancel' || m.message.type === 'finished') {
                removeMatchFromStorage(m.message.id);
            }
        }
    }
});

// MaÃ§larÄ± kalÄ±cÄ± yapma sistemi
function saveAndRenderMatch(owner, id, amt) {
    if(!allMatches.find(m => m.id === id)) {
        allMatches.push({owner, id, amt});
        localStorage.setItem('global_matches_v3', JSON.stringify(allMatches));
    }
    renderMatchCard(owner, id, amt);
}

function removeMatchFromStorage(id) {
    allMatches = allMatches.filter(m => m.id !== id);
    localStorage.setItem('global_matches_v3', JSON.stringify(allMatches));
    document.getElementById(id)?.remove();
}

// KATILMA SÄ°STEMÄ° - DeÄŸer KontrollÃ¼
let joiningMatchId = null;
let requiredAmt = 0;

function openJoinInv(id, amt) {
    joiningMatchId = id;
    requiredAmt = amt;
    openInv(); // Mevcut envanter modÃ¼lÃ¼nÃ¼ aÃ§ar
}

function createMatch() {
    if(selectedCount === 0) return;
    
    // EÄŸer bir maÃ§a katÄ±lmak iÃ§in envanter aÃ§Ä±ldÄ±ysa
    if(joiningMatchId) {
        if(selectedCount !== requiredAmt) {
            alert("Hata: Bu maÃ§a katÄ±lmak iÃ§in tam olarak " + requiredAmt + " adet item seÃ§melisin!");
            return;
        }
        // MaÃ§Ä± bitir ve her iki taraftan sil
        pubnub.publish({ channel: CH_MATCH, message: { type: 'finished', id: joiningMatchId } });
        invCount -= selectedCount;
        alert("MaÃ§a katÄ±ldÄ±n! Zarlar atÄ±lÄ±yor...");
        joiningMatchId = null;
    } else {
        // Normal maÃ§ oluÅŸturma
        const mId = "M_" + Math.random().toString(36).substr(2, 8);
        const amount = selectedCount;
        saveAndRenderMatch(user, mId, amount);
        invCount -= amount;
        pubnub.publish({ channel: CH_MATCH, message: { type: 'new', user: user, id: mId, amt: amount } });
    }
    
    updateUI();
    closeInv();
}

function renderMatchCard(owner, id, amt) {
    if(document.getElementById(id)) return;
    const list = document.getElementById('match-list');
    const div = document.createElement('div');
    div.className = "match-card";
    div.id = id;

    let itemsHtml = "";
    for(let i=0; i<amt; i++) itemsHtml += `<img src="${ITEM_IMG}" class="item-mini-img">`;

    div.innerHTML = `
        <div class="match-top">
            <div class="match-user-info"><b>${owner}</b></div>
            <div class="value-tag">ğŸ’ ${(amt * HARVESTER_VALUE).toLocaleString()}</div>
        </div>
        <div class="item-display-area">${itemsHtml}</div>
        <div style="display:flex; justify-content:flex-end">
            ${owner === user 
                ? `<button class="btn btn-red" style="width:80px; padding:5px" onclick="cancelMatch('${id}', ${amt})">Ä°PTAL</button>` 
                : `<button class="btn" style="width:80px; padding:5px" onclick="openJoinInv('${id}', ${amt})">KATIL</button>`}
        </div>
    `;
    list.prepend(div);
}

// ... (Geri kalan CSS ve fonksiyonlar aynÄ± kalacak ÅŸekilde GitHub'daki index.html'ini gÃ¼ncelle)
</script>
